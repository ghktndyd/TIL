# 1. Atomic 클래스

- 자바에서 멀티스레드 환경에서 변수 값을 Atomic하게 처리 가능하도록 해주는 클래스들
- 여기서 Atomic 하다는 것은 원자적이라는 뜻인데, 또 원자적이라는 것은 "하나의 연산을 더 이상 쪼갤 수 없는 단일 연산으로 취급한다"는 의미
- 즉 어떤 연산이 시작되면 그 연산이 끝날 때까지는 다른 스레드가 끼어들 수 없다는 것

- ➡️일반적인 연산은 `읽기 -> 수정 -> 쓰기`의 3단계를 거친다.
- 이 과정에서 다른 스레드가 끼어든다면 데이터가 꼬일 수 있다.
- 자바에서는 이를 막기 위해서 `synchronized`를 쓸 수 있지만
- 이건 락을 걸어서 다른 스레드가 접근하지 못 하게 하는 방식이라서 성능상 좋지 않다.
- 반면 Atomic 클래스들은 락-프리 방식이라서 CAS 원리를 사용해서 성능상 나쁘지 않다.

# 2. Atomic은 어떻게 원자성을 보장하는가?

- CAS(Compare And Swap) 이라는 기법을 사용한다고 했다.
- 이거는 쉽게 말하면 현재 값이 내가 기대하는 값과 같으면 새로운 값으로 교체
- 그렇지 않으면 다시 시도하는 방식이다.
- 위 과정을 JVM이 OS의 Compare-And-Set 명령어로 실행한다.

# 3. ABA 문제

- CAS는 현재 값이 내가 기대하는 값과 같으면 새로운 값으로 교체하는 방식이라고 했다.
- 그런데 만약에 CAS 연산에서 기대값이 A 이고, 현재 메모리의 값도 A라서 교체하려는데
- 알고 보니까 그 사이의 값이 A -> B -> A로 바뀐 경우라면 CAS는 값만 비교하니까 중간에 변동이 있었다는 것을 모르는 문제가
- **ABA 문제**라고 한다.

- 예를 들면
- 내가 은행에서 잔액 확인을 했는데 잔액이 10만원이었다.
- 근데 5,000원이 필요해서 출금했다. 잔액은 9만 5천원이 되었다.
- 그런데 엄마가 5,000원을 입금해줘서 잔액이 다시 10만원이 되었다.
- 나는 이 사실을 모르고, 잔액을 다시 확인했는데 10만원이었다.
- 그래서 "엥? 내가 돈을 안 뽑았나?" 생각하고 다시 출금을 한다.

- 위와 같은 상황은 데이터의 정합성을 해칠 수 있다.
- 또 중간 상태가 중요한 상황에서 중간 상태를 모르고 버그가 발생할 수 있다.

# 4. ABA 문제 해결 방법

- 자바에서는 `AtomicStampedReference` 클래스가 있다.
- 이 클래스는 CAS 연산을 할 때 스탬프라고 하는 버젼 번호를 같이 관리한다
- 값을 바꿀 떄마다 스탬프도 같이 변경해준다.
- 결론적으로 CAS 할 때 값도 같아야 하고, 스탬프도 같아야 성공한다

# 5. Atomic 클래스는 언제 사용해야 할까?

- static 변수들을 멀티스레드 환경에서 안전하게 수정해야 할 때
- 배치 프로그램에서 멀티스레드 환경에서 안전하게 카운팅해야 할 때
